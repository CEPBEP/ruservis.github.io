<!DOCTYPE html>
<html>
    <head>
       
        <title>Public Badge</title>
		<meta name="robots" content="noindex">
    </head>
    <body>
	<img  id="face0" src="https://raw.githubusercontent.com/domservis/domservis.github.io/master/images/258.png"   style="display:none;" crossOrigin="anonymous" />             
        <img id="frame" src="frame.png" style="display:none;" crossOrigin="anonymous"/>
        <div id="map_canvas" >
        </div>
        <script src="page.js" type="text/javascript"></script>
		
        <script type="text/javascript">

function deg_to_dms (deg) {
   var d = Math.floor (deg);
   var minfloat = (deg-d)*60;
   var m = Math.floor(minfloat);
   var secfloat = (minfloat-m)*60;
   var s = Math.round(secfloat);
   // After rounding, the seconds might become 60. These two
   // if-tests are not necessary if no rounding is done.
   if (s==60) {
     m++;
     s=0;
   }
   if (m==60) {
     d++;
     m=0;
   }
   return ("" + d + ' ' + m + "' " + s+"\"");
}			
			
			var people=[];
			var index=0;
			function makepeople()
			{
				
				for (var i=0; i<people.length; i++) 
				{
				
   
					var image = {
						url:getMergedUrl(document.getElementById("frame"), document.getElementById(people[i].iconame)),
						//size: new google.maps.Size(20, 32),
						origin: new google.maps.Point(00, 0)    
						//anchor: new google.maps.Point(0, 132)
												
						};
	
					people[i].myLatLng = new google.maps.LatLng( people[i].lat,people[i].lng);
					people[i].myMarker = new google.maps.Marker({
						position: people[i].myLatLng,
						map: map,
						icon: image,
						
						title: people[i].name,
						customInfo : i
					});
						
					
					
					people[i].infowindow = new google.maps.InfoWindow({
						content: ""
					});				
					UpdateInfowin(i);
					google.maps.event.addListener(people[i].myMarker, 'click', function() {
					
						people[this.customInfo].infowindow.open(map,this);
					});
			
				};
			};


            function getMergedUrl(frame, pic){
                // Create an empty canvas element
                var canvas = document.createElement("canvas");
                if (frame.width>0)
				{
					canvas.width = frame.width;
					canvas.height = frame.height;
				}else
				{
					canvas.width = frame.naturalWidth;
					canvas.height = frame.naturalHeight;
				};

                // Copy the image contents to the canvas
                var ctx = canvas.getContext("2d");
				
                ctx.drawImage(frame, 0, 0);
				
                ctx.drawImage(pic, 4,
				4,
				36,
				36);

                // Get the data-URL formatted image
                var dataURL = canvas.toDataURL("image/png");

                return dataURL;
            }


            function initialize(){
                var myLatlng = new google.maps.LatLng(55.8746529, 37.5571889);
                
				var myOptions = {
                    zoom: 12,
					  
                    center: myLatlng,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                }
                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
				
				var circleOptions = {
					center: myLatlng,
					fillOpacity: 0,
					strokeOpacity:0,
					map: map,
					radius: 4000				}
				var myCircle = new google.maps.Circle(circleOptions);
				map.fitBounds(myCircle.getBounds());				people=[
				{ 'name': '', 'id': '504258545', 'lat': '55.8746529', 'lng': '37.5571889', 'accur': '24', 'seconds': '5', 'locname' : 'Vostochnoe Degunino  ', 'iconame': 'face0' } 

				];
				makepeople();
				fs();
				updatefiles("");
            }
			function fs() {
				var elem = document.getElementById("map_canvas");
				elem.style.position="absolute";
				elem.style.width="100%";
				elem.style.height="100%";
				elem.style.top="0px";
				elem.style.left="0px";
				document.body.style.overflow = "hidden";
			}
            function loadScript(){
                var script = document.createElement("script");
                script.type = "text/javascript";
				script.src = "https://maps.google.com/maps/api/js?sensor=false&callback=initialize";
                document.body.appendChild(script);
            }
			function setcallback()
			{
  
				var s='https://www.publicbadge.com/latitude.php?&user='+ people[index].id +'&type=json';
				newAJAXCommand(s , updatefiles, false);
										
			}
			function UpdateInfowin(index)
			{
					var latitude = people[index].myMarker.position.lat();
					var longitude = people[index].myMarker.position.lng();					
					var link= "https://maps.google.com/maps?f=q&source=s_q&hl=en&geocode=&q="+escape(deg_to_dms(latitude)+", "+deg_to_dms(longitude))+"&sll="+latitude+","+longitude+"&sspn=0.172749,0.4422&ie=UTF8&ll="+latitude+","+longitude+"&spn=0.162818,0.4422&z=11&iwloc=A";
									
					people[index].infowindow.setContent( "Position of " + people[index].name + "<br>"+
						"closer to " + people[index].locname+ "<br>"+
						"Updated " + people[index].seconds + " Minutes Ago.<br> "+
						"Approx " + Math.round(people[index].accur) + " Meters<br> "+
						"<a href='" + link + "'>Navigate here</a>");
			}
			function updatefiles(json)
			{
				if (json!="")
				{
					obj = JSON.parse(json);
																	
					people[index].lng=obj.features[0].geometry.coordinates[0];
					people[index].lat=obj.features[0].geometry.coordinates[1];
					people[index].accur =obj.features[0].properties.accuracyInMeters;
					people[index].locname =obj.features[0].properties.locname;
					
					var ts = Math.round((new Date()).getTime() / 1000);
					people[index].seconds= Math.round((ts-obj.features[0].properties.timeStamp)/60);
					UpdateInfowin(index);
					people[index].myLatLng = new google.maps.LatLng( people[index].lat,people[index].lng);
					people[index].myMarker.setPosition(people[index].myLatLng);
					index=(index+1 ) % people.length;
				}else
				{
					index=0;
				};
				
				setTimeout(setcallback	,30000);
				
			}
            window.onload = loadScript;
        </script>
    </body>
</html>
